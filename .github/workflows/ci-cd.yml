name: ci-cd

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run tests
        run: |
          if command -v pytest >/dev/null 2>&1; then
            pytest
          else
            echo "pytest not installed or no tests yet - skipping"
          fi

      - name: Install Bandit
        run: |
          pip install bandit

      - name: Run Bandit SAST scan
        run: |
          bandit -r . -ll -ii -f txt -o bandit-report.txt

      - name: Show Bandit report in logs
        if: always()
        run: |
          echo "===== BANDIT REPORT START ====="
          cat bandit-report.txt || echo "Brak pliku bandit-report.txt"
          echo "===== BANDIT REPORT END ====="

      - name: Upload Bandit report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.txt

  build-image:
    needs: tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write 
      contents: read 
    env:
      AWS_REGION: eu-north-1     
      AWS_ACCOUNT_ID: "954552668021"     
      ECR_REPOSITORY: "forum-app-test-repo"         
      IMAGE_TAG: "${{ github.sha }}"        

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::954552668021:role/github-actions-eks-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION \
            | docker login \
              --username AWS \
              --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      - name: Build Docker image
        run: |
          echo "Building Docker image with tag: $IMAGE_TAG"
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG forum_proj

          # Tag with commit SHA (primary tag)
          docker tag $ECR_REPOSITORY:$IMAGE_TAG \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
          
          # Also tag as 'latest' for convenience
          docker tag $ECR_REPOSITORY:$IMAGE_TAG \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:latest

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          format: 'table'      
          exit-code: '0'              
          ignore-unfixed: true       
          vuln-type: 'os,library'          
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          
      - name: Push image to Amazon ECR
        run: |
          echo "Pushing image with SHA tag: $IMAGE_TAG"
          docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
          
          echo "Pushing image with latest tag"
          docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:latest

  deploy-to-eks:
    needs: build-image
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: eu-north-1
      AWS_ACCOUNT_ID: "954552668021"
      EKS_CLUSTER_NAME: "forum-app"
      K8S_NAMESPACE: "forum-namespace"
      K8S_DEPLOYMENT: "forum-webapp"
      K8S_CONTAINER_NAME: "forum-webapp"
      ECR_REPOSITORY: "forum-app-test-repo"
      IMAGE_TAG: "${{ github.sha }}"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::954552668021:role/github-actions-eks-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --name $EKS_CLUSTER_NAME \
            --region $AWS_REGION

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Update deployment with new image
        run: |
          NEW_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG"
          TIMESTAMP=$(date +%s)
          
          echo "Updating deployment to image: $NEW_IMAGE"
          echo "Adding rollout timestamp: $TIMESTAMP"
          
          # Patch both image and annotation to force rollout
          kubectl patch deployment $K8S_DEPLOYMENT -n $K8S_NAMESPACE \
            --type='json' \
            -p="[
              {\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/image\", \"value\": \"$NEW_IMAGE\"},
              {\"op\": \"replace\", \"path\": \"/spec/template/metadata/annotations/rollout-timestamp\", \"value\": \"$TIMESTAMP\"}
            ]"

      - name: Wait for rollout to complete
        run: |
          echo "Waiting for deployment rollout to complete..."
          kubectl rollout status deployment/$K8S_DEPLOYMENT \
            -n $K8S_NAMESPACE \
            --timeout=300s

      - name: Verify deployment
        run: |
          echo "===== Deployment Status ====="
          kubectl get deployment $K8S_DEPLOYMENT -n $K8S_NAMESPACE
          
          echo ""
          echo "===== Running Pods ====="
          kubectl get pods -n $K8S_NAMESPACE -l app=$K8S_DEPLOYMENT
          
          echo ""
          echo "===== Deployed Image ====="
          DEPLOYED_IMAGE=$(kubectl get deployment $K8S_DEPLOYMENT -n $K8S_NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].image}')
          echo "Current image: $DEPLOYED_IMAGE"
          
          EXPECTED_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "Expected image: $EXPECTED_IMAGE"
          
          if [ "$DEPLOYED_IMAGE" = "$EXPECTED_IMAGE" ]; then
            echo "Image verification successful!"
          else
            echo "Image mismatch detected!"
            exit 1
          fi

      - name: Show recent events (if deployment failed)
        if: failure()
        run: |
          echo "===== Recent Events ====="
          kubectl get events -n $K8S_NAMESPACE --sort-by='.lastTimestamp' | tail -20
          
          echo ""
          echo "===== Pod Logs ====="
          kubectl logs -n $K8S_NAMESPACE -l app=$K8S_DEPLOYMENT --tail=50 || true

  dast-zap:
    needs: deploy-to-eks
    runs-on: ubuntu-latest

    env:
      APP_URL: "https://iho-test.xyz"

    steps:
      - name: Wait for application to be ready
        run: |
          echo "Waiting 30 seconds for application to stabilize..."
          sleep 30

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: ${{ env.APP_URL }}
          fail_action: false
          allow_issue_writing: false
          cmd_options: "-a"